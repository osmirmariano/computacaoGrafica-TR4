//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop
#include <math.hpp>
#define min(a, b)  (((a) < (b)) ? (a) : (b))
#define max(a, b)  (((a) > (b)) ? (a) : (b))

#include "transformacao.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm3 *Form3;
//---------------------------------------------------------------------------
__fastcall TForm3::TForm3(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TForm3::Button4Click(TObject *Sender)
{

	float angle;	//45° for example

	float newx, newy, x, y, radian, E_PI, degree=2;

	//encontrar a largura e a altura do retângulo delimitador que correspondem à largura e altura do bitmap de destino
	newx = x * cos(angle) + y * sin(angle);
	newy = y * cos(angle) - x * sin(angle);

	//----------------------------
	//Converter graus para radianos
	radian = (2 * E_PI * degree) / 360;
	//----------------------------
	angle = Edit1->Text.ToDouble();
	Graphics::TBitmap *SrcBitmap=new Graphics::TBitmap;
	Graphics::TBitmap *DestBitmap=new Graphics::TBitmap;
	SrcBitmap->LoadFromFile("cg.bmp");

	//Converter graus para radianos
	float radians=(2*3.1416*angle)/360;

	float cosine=(float)cos(radians);
	float sine=(float)sin(radians);

	float Point1x=(-SrcBitmap->Height*sine);
	float Point1y=(SrcBitmap->Height*cosine);
	float Point2x=(SrcBitmap->Width*cosine-SrcBitmap->Height*sine);
	float Point2y=(SrcBitmap->Height*cosine+SrcBitmap->Width*sine);
	float Point3x=(SrcBitmap->Width*cosine);
	float Point3y=(SrcBitmap->Width*sine);

	float minx=min(0,min(Point1x,min(Point2x,Point3x)));
	float miny=min(0,min(Point1y,min(Point2y,Point3y)));
	float maxx=max(Point1x,max(Point2x,Point3x));
	float maxy=max(Point1y,max(Point2y,Point3y));

	int DestBitmapWidth=(int)ceil(fabs(maxx)-minx);
	int DestBitmapHeight=(int)ceil(fabs(maxy)-miny);

	DestBitmap->Height=DestBitmapHeight;
	DestBitmap->Width=DestBitmapWidth;

	//toma cada pixel no bitmap de destino e obtem seu valor no bitmap de origem usando as mesmas fórmulas
	for(int x=0;x<DestBitmapWidth;x++)
	{
	  for(int y=0;y<DestBitmapHeight;y++)
	  {
		int SrcBitmapx=(int)((x+minx)*cosine+(y+miny)*sine);
		int SrcBitmapy=(int)((y+miny)*cosine-(x+minx)*sine);
		if(SrcBitmapx>=0&&SrcBitmapx<SrcBitmap->Width&&SrcBitmapy>=0&&
			 SrcBitmapy<SrcBitmap->Height)
		{
		  DestBitmap->Canvas->Pixels[x][y]=
			  SrcBitmap->Canvas->Pixels[SrcBitmapx][SrcBitmapy];
		}
	  }
	}
	//Mostrar o bitmap girado
	Image1->Picture->Bitmap=DestBitmap;
	delete DestBitmap;
	delete SrcBitmap;
}
//---------------------------------------------------------------------------
void __fastcall TForm3::Button5Click(TObject *Sender)
{
	Image1->Picture->LoadFromFile("cg.bmp"); // Carregando imagem
	Image1->Stretch = true; //redimensiona
	Image1->Refresh(); //atualiza
}
//---------------------------------------------------------------------------

